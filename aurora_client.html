<!DOCTYPE html>
<html>
<head>
    <title>Aurora - Pinecone Memory Integration</title>
    <script crossorigin src="https://unpkg.com/@daily-co/daily-js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        #status {
            font-size: 18px;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        #messages {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 5px;
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #333;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #00ff88;
            padding-left: 10px;
        }
        .user-speech {
            background: #003322;
            color: #00ff88;
            font-weight: bold;
        }
        .replica-speech {
            background: #222244;
            color: #8888ff;
        }
        .system-message {
            color: #888;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>ðŸš€ Aurora - AI with Pinecone Memory</h1>
    <p style="color: #888; margin-bottom: 20px;">
        Enhanced with Pinecone vector memory + Cohere embeddings. 
        Aurora remembers you're <strong>Abiodun</strong>, a computer science student! ðŸ§ 
    </p>
    <div id="status">Connecting...</div>
    <div id="messages"></div>

    <script>
        let call;
        const BACKEND_URL = "http://localhost:8000";
        const TAVUS_BACKEND_URL = "http://localhost:8000"; // Using same service for simplicity
        let conversationId;
        const USER_ID = "abiodun"; // Your user ID
        
        const addMessage = (msg, type = 'system') => {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${msg}`;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
            console.log(msg);
        };

        // Create a new conversation using our Pinecone + Tavus integration
        async function createConversation() {
            try {
                // First check integration status
                const statusResponse = await fetch(`${TAVUS_BACKEND_URL}/api/integration-status?user_id=${USER_ID}`);
                const statusData = await statusResponse.json();
                addMessage(`ðŸ§  Memory system: ${statusData.user_profile?.total_memories || 0} memories stored`, 'system-message');
                
                // Start a new Tavus conversation with your memory context
                const response = await fetch(`${TAVUS_BACKEND_URL}/api/start-conversation?user_id=${USER_ID}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await response.json();

                if (data.conversation_id) {
                    conversationId = data.conversation_id;
                    addMessage(`âœ… Aurora conversation created: ${conversationId}`, 'system-message');
                    addMessage(`ðŸŽ­ Context loaded: Knows you're ${statusData.user_profile?.remembered_name || 'Abiodun'}`, 'system-message');
                    return data.conversation_url || `https://tavus.daily.co/${conversationId}`;
                } else {
                    throw new Error('No conversation URL/ID returned by backend');
                }
            } catch (error) {
                addMessage(`âŒ Failed to create conversation: ${error.message}`, 'system-message');
                return null;  // do NOT join an invalid room
            }
        }

        addMessage('Creating new conversation...', 'system-message');

        // Initialize conversation and Daily frame
        createConversation().then(conversationURL => {
            if (!conversationURL) {
                addMessage('âŒ No valid conversation URL returned; cannot join.', 'system-message');
                return;
            }

            addMessage('Creating Daily frame...', 'system-message');

            try {
            call = window.Daily.createFrame();
            addMessage('Daily frame created', 'system-message');
            
            call.on('app-message', (event) => {
                const data = event.data;
                console.log('App message:', data);
                
                if (data.event_type === 'conversation.utterance') {
                    const speech = data.properties.speech;
                    const role = data.properties.role;
                    
                    if (role === 'user' && speech) {
                        addMessage(`You said: ${speech}`, 'user-speech');
                        
                        // Send to backend for processing with conversation ID
                        if (!conversationId) {
                            addMessage('âŒ No conversation ID available', 'system-message');
                            return;
                        }

                        fetch(`${BACKEND_URL}/api/process-speech`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                text: speech,
                                conversation_id: conversationId,
                                user_id: USER_ID  // Use the same user_id as conversation creation
                            })
                        })
                        .then(response => response.json())
                        .then(result => {
                            addMessage('Speech processed and analyzed!', 'system-message');
                            
                            // Show analysis results
                            const analysis = result.speech_record.analysis;
                            addMessage(`Analysis: ${analysis.topic} | ${analysis.emotion} | Importance: ${analysis.importance}/10`, 'system-message');
                        })
                        .catch(err => {
                            addMessage(`Error sending to backend: ${err}`, 'system-message');
                        });
                        
                    } else if (role === 'replica' && speech) {
                        addMessage(`Aurora said: ${speech}`, 'replica-speech');
                    }
                }
                else if (data.event_type === 'conversation.user.started_speaking') {
                    addMessage('You started speaking...', 'system-message');
                }
                else if (data.event_type === 'conversation.replica.started_speaking') {
                    addMessage('Aurora is responding...', 'system-message');
                }
            });
            
            call.on('joined-meeting', () => {
                addMessage('Connected to Aurora! Start speaking...', 'system-message');
                document.getElementById('status').textContent = 'Connected! Aurora is listening...';
                document.getElementById('status').style.background = '#003322';
            });
            
            call.on('error', (error) => {
                addMessage(`Error: ${error}`, 'system-message');
            });
            
            // Use the conversation URL from the createConversation response
            addMessage(`Joining: ${conversationURL}`, 'system-message');
            call.join({ url: conversationURL });

            } catch (error) {
                addMessage(`JavaScript error: ${error}`, 'system-message');
            }
        });

        // Add function to get current metrics
        function getMetrics() {
            fetch(`${BACKEND_URL}/api/metrics`)
            .then(response => response.json())
            .then(metrics => {
                addMessage(`Current Metrics - Relationship: ${metrics.relationship_level.toFixed(1)}/100, Trust: ${metrics.trust_level.toFixed(1)}/100, Emotion: ${metrics.current_emotion}`, 'system-message');
            });
        }

        // Get metrics every 10 seconds
        setInterval(getMetrics, 10000);
    </script>
</body>
</html>